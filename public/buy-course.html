<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy Course - Coin Academia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f4ff;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .containerStarter {
      max-width: 600px;
      width: 90%;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 32px;
      text-align: center;
      box-sizing: border-box;
    }
    .containerStarter h1 {
      letter-spacing: 0.5px;
      font-weight: 700;
      font-size: 2.2em;
      color: #0052ff;
      margin-bottom: 12px;
    }
    .containerStarter .subtitle {
      color: #444;
      font-size: 1.1em;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .feature-list {
      text-align: left;
      margin: 0 auto 22px auto;
      padding: 0 0 0 20px;
      color: #222;
      font-size: 1em;
      line-height: 1.7;
      list-style: none;
    }
    .feature-list li {
      margin-bottom: 8px;
      padding-left: 0;
      position: relative;
      padding-left: 28px;
    }
    .feature-list li:before {
      content: "âœ“";
      color: #009e3c;
      font-weight: bold;
      position: absolute;
      left: 0;
    }
    .price-section {
      margin: 24px 0 16px 0;
      font-size: 1.6em;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .old-price {
      color: #aaa;
      text-decoration: line-through;
      font-size: 1em;
    }
    .new-price {
      color: #009e3c;
      font-weight: bold;
      font-size: 1.3em;
    }
    .discount-badge {
      background: #ffe066;
      color: #b8860b;
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 0.9em;
      margin-left: 6px;
      font-weight: 600;
    }
    #buyBtn {
      background: linear-gradient(90deg, #0052ff 60%, #00c6fb 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 16px 0;
      font-size: 1.3em;
      font-weight: 600;
      width: 100%;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,82,255,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    #buyBtn:hover {
      background: linear-gradient(90deg, #003bb3 70%, #009e3c 100%);
      box-shadow: 0 6px 20px rgba(0,82,255,0.15);
      transform: translateY(-2px);
    }
    #buyBtn:disabled {
      background: #ccc;
      transform: none;
      box-shadow: none;
      cursor: not-allowed;
    }
    .info-note {
      margin-top: 24px;
      color: #555;
      font-size: 0.95em;
      background: #f3f7ff;
      border-radius: 8px;
      padding: 16px;
      line-height: 1.6;
      text-align: center;
    }
    .info-note .secure {
      color: #009e3c;
      font-size: 1.2em;
      margin-right: 6px;
    }
    #error {
      color: #d32f2f;
      font-size: 1em;
      margin-top: 12px;
      padding: 8px 12px;
      background: #ffebee;
      border-radius: 6px;
      display: none;
    }
    #usdt-estimate {
      display: block;
      font-size: 0.95em;
      color: #666;
      margin-top: 8px;
    }
    @media (max-width: 768px) {
      .containerStarter {
        padding: 24px 16px;
        margin: 20px auto;
      }
      .containerStarter h1 {
        font-size: 1.8em;
      }
      .feature-list {
        font-size: 0.95em;
      }
      #buyBtn {
        padding: 14px 0;
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="containerStarter">
    <h1 id="course-title">Course</h1>
    <p class="subtitle" id="course-desc"></p>
    <ul class="feature-list" id="feature-list"></ul>
    <div class="price-section">
      <span class="old-price" id="old-price"></span>
      <span class="new-price" id="new-price"></span>
      <span class="discount-badge" id="discount-badge"></span>
    </div>
    <span id="usdt-estimate"></span>
    <button id="buyBtn">Pay with Crypto <span style="font-size:1.1em;">&#128176;</span></button>
    <div id="error"></div>
    <div class="info-note">
      <span class="secure">ðŸ”’</span>
      Instant access after payment.<br>
      Secure checkout powered by <strong>NOWPayments</strong>.<br>
      <span style="color:#0052ff;">Start learning smarter today!</span>
    </div>
  </div>

  <script>
    // Enhanced Course Data
    const courses = {
      'starter': {
        title: 'STARTER PARK',
        desc: 'Unlock your crypto journey with our exclusive <strong>Starter Park</strong> course!',
        features: [
          'Learn the fundamentals of cryptocurrency',
          'Understand blockchain technology',
          'Secure investing tips & strategies'
        ],
        oldPrice: 100,
        newPrice: 90,
        discount: '10% OFF',
        orderId: 'STARTER-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
        orderDesc: 'Starter Park Course'
      },
      'trading': {
        title: 'Trading Strategies',
        desc: 'Explore proven trading strategies and risk management for crypto success!',
        features: [
          'Step-by-step trading tactics',
          'Risk management essentials',
          'Real-world crypto trading examples'
        ],
        oldPrice: 300,
        newPrice: 250,
        discount: '17% OFF',
        orderId: 'TRADING-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
        orderDesc: 'Trading Strategies Course'
      },
      'technical': {
        title: 'Technical Analysis',
        desc: 'Master chart patterns, indicators, and technical tools for crypto trading!',
        features: [
          'In-depth chart pattern analysis',
          'Technical indicators and signals',
          'Real-world trading strategies'
        ],
        oldPrice: 400,
        newPrice: 350,
        discount: '12% OFF',
        orderId: 'TECHNICAL-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
        orderDesc: 'Technical Analysis Course'
      },
      'portfolio': {
        title: 'Portfolio Management',
        desc: 'Master the art of building and managing a high-performing crypto portfolio!',
        features: [
          'Diversification strategies for crypto assets',
          'Risk management and rebalancing techniques',
          'Long-term growth planning'
        ],
        oldPrice: 600,
        newPrice: 500,
        discount: '17% OFF',
        orderId: 'PORTFOLIO-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
        orderDesc: 'Portfolio Management'
      },
      'masterclass': {
        title: 'Masterclass: Wealth Building',
        desc: 'Unlock elite-level strategies and wealth-building secrets with our <strong>Masterclass</strong> course!',
        features: [
          'Advanced portfolio scaling & management',
          'Wealth-building strategies for serious investors',
          'Exclusive insights from top crypto experts'
        ],
        oldPrice: 1200,
        newPrice: 1000,
        discount: '17% OFF',
        orderId: 'MASTERCLASS-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
        orderDesc: 'Masterclass: Wealth Building'
      }
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Get course from URL (?course=trading)
      const urlParams = new URLSearchParams(window.location.search);
      const courseKey = urlParams.get('course') || 'starter';
      const course = courses[courseKey];
      
      // Populate page with course data
      if (course) {
        document.getElementById('course-title').textContent = course.title;
        document.getElementById('course-desc').innerHTML = course.desc;
        document.getElementById('old-price').textContent = `$${course.oldPrice}`;
        document.getElementById('new-price').textContent = `$${course.newPrice}`;
        document.getElementById('discount-badge').textContent = course.discount;
        document.getElementById('feature-list').innerHTML = course.features.map(f => `<li>${f}</li>`).join('');
        
        // Update USDT estimate
        updateUSDT(course.newPrice);
        
        // Setup payment button
        setupPaymentButton(course);
      } else {
        showError('Invalid course selected');
      }
    });

    // Update USDT price estimate
    async function updateUSDT(priceUSD) {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=usd');
        
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.tether && data.tether.usd) {
          const usdtRate = data.tether.usd;
          const usdtAmount = priceUSD / usdtRate;
          document.getElementById('usdt-estimate').textContent = `â‰ˆ ${usdtAmount.toFixed(6)} USDT (live rate)`;
        } else {
          throw new Error('Invalid response format from CoinGecko API');
        }
      } catch (error) {
        console.error('Failed to fetch USDT price:', error);
        document.getElementById('usdt-estimate').textContent = 'USDT estimate unavailable';
      }
    }

    // Setup payment button with enhanced error handling
    function setupPaymentButton(course) {
      const buyBtn = document.getElementById('buyBtn');
      const errorDiv = document.getElementById('error');
      
      buyBtn.addEventListener('click', async function() {
        // Reset UI state
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        buyBtn.disabled = true;
        buyBtn.textContent = 'Processing Payment...';
        
        try {
          // Create payment request
          const paymentData = {
            price_amount: course.newPrice,
            price_currency: 'usd',
            order_id: course.orderId,
            order_description: course.orderDesc,
            success_url: window.location.origin + '/course-unlocked.html',
            cancel_url: window.location.href
          };
          
          console.log('Sending payment request:', paymentData);
          
          const response = await fetch('https://www.coinacademia.in/api/create-checkout', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(paymentData)
          });
          
          console.log('Received response:', response);
          
          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Unexpected response format: ${text.substring(0, 100)}...`);
          }
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || `Payment failed with status ${response.status}`);
          }
          
          if (data.hosted_url) {
            console.log('Redirecting to payment page:', data.hosted_url);
            window.location.href = data.hosted_url;
          } else {
            throw new Error(data.error || 'Payment URL not received');
          }
        } catch (error) {
          console.error('Payment error:', error);
          errorDiv.textContent = `Payment error: ${error.message}`;
          errorDiv.style.display = 'block';
          buyBtn.disabled = false;
          buyBtn.textContent = 'Pay with Crypto ðŸ’°';
          
          // Optional: Send error to your error tracking system
          logErrorToServer(error);
        }
      });
    }

    // Helper function to display errors
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // Optional: Function to log errors to your server
    function logErrorToServer(error) {
      // You can implement error logging to your backend here
      // Example:
      /*
      fetch('/api/log-error', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          error: error.message,
          stack: error.stack,
          page: window.location.href,
          timestamp: new Date().toISOString()
        })
      }).catch(e => console.error('Failed to log error:', e));
      */
    }
  </script>
</body>
</html>
